
//=======================================================
//  This code is generated by Terasic System Builder
//=======================================================

module DE0_ANNICK(

	//////////// CLOCK //////////
	CLOCK_50,

	//////////// LED //////////
	LED,

	//////////// KEY //////////
	KEY,

	//////////// SW //////////
	SW,

	//////////// SDRAM //////////
	DRAM_ADDR,
	DRAM_BA,
	DRAM_CAS_N,
	DRAM_CKE,
	DRAM_CLK,
	DRAM_CS_N,
	DRAM_DQ,
	DRAM_DQM,
	DRAM_RAS_N,
	DRAM_WE_N,

	//////////// EPCS //////////
	EPCS_ASDO,
	EPCS_DATA0,
	EPCS_DCLK,
	EPCS_NCSO,

	//////////// EEPROM //////////
	I2C_SCLK,
	I2C_SDAT,

	//////////// ADC //////////
	ADC_CS_N,
	ADC_SADDR,
	ADC_SCLK,
	ADC_SDAT,

	//////////// 2x13 GPIO Header //////////
	GPIO_2,
	GPIO_2_IN,

	//////////// GPIO_0, GPIO_0 connect to GPIO Default //////////
	GPIO_0,
	GPIO_0_IN,

	//////////// GPIO_1, GPIO_1 connect to GPIO Default //////////
	GPIO_1,
	GPIO_1_IN 
);

//=======================================================
//  PARAMETER declarations
//=======================================================


//=======================================================
//  PORT declarations
//=======================================================

//////////// CLOCK //////////
input 		          		CLOCK_50;

//////////// LED //////////
output		     [7:0]		LED;

//////////// KEY //////////
input 		     [1:0]		KEY;

//////////// SW //////////
input 		     [3:0]		SW;

//////////// SDRAM //////////
output		    [12:0]		DRAM_ADDR;
output		     [1:0]		DRAM_BA;
output		          		DRAM_CAS_N;
output		          		DRAM_CKE;
output		          		DRAM_CLK;
output		          		DRAM_CS_N;
inout 		    [15:0]		DRAM_DQ;
output		     [1:0]		DRAM_DQM;
output		          		DRAM_RAS_N;
output		          		DRAM_WE_N;

//////////// EPCS //////////
output		          		EPCS_ASDO;
input 		          		EPCS_DATA0;
output		          		EPCS_DCLK;
output		          		EPCS_NCSO;

//////////// EEPROM //////////
output		          		I2C_SCLK;
inout 		          		I2C_SDAT;

//////////// ADC //////////
output		          		ADC_CS_N;
output		          		ADC_SADDR;
output		          		ADC_SCLK;
input 		          		ADC_SDAT;

//////////// 2x13 GPIO Header //////////
inout 		    [12:0]		GPIO_2;
input 		     [2:0]		GPIO_2_IN;

//////////// GPIO_0, GPIO_0 connect to GPIO Default //////////
inout 		    [33:0]		GPIO_0;
input 		     [1:0]		GPIO_0_IN;

//////////// GPIO_1, GPIO_1 connect to GPIO Default //////////
inout 		    [33:0]		GPIO_1;
input 		     [1:0]		GPIO_1_IN;


//=======================================================
//  REG/WIRE declarations
//=======================================================




//=======================================================
//  Structural coding
//=======================================================

//////// Stored Data assignement SENSORS //////////

logic [31:0] Odometre_Left, Odometre_Right;

always_comb begin
	case(AddrFromPi)
		8'h0f : DataToPI = 32'h0f0f0f0f;		//TEST
		8'hf0 : DataToPI = 32'hffff00f0;		//TEST

		8'h20 : DataToPI = Odometre_Right;  	// Odomètre gauche 	: 0x20
		8'h21 : DataToPI = Odometre_Left; 		// Odomètre droit 	: 0x21
		default : DataToPI = 32'bx; 		
	endcase
end

//////// Data assignement for ACTUATORS //////////


// ---  SPI module instantiation ---------------------------------------------

logic spi_clk, spi_cs, spi_mosi, spi_miso;
logic [31:0] DataFromPI;
logic [31:0] DataToPI;
logic [7:0]  AddrFromPi;

spi_slave spi_slave_inst (
	.SPI_CLK(spi_clk),
	.SPI_CS(spi_cs),
	.SPI_MOSI(spi_mosi),
	.SPI_MISO(spi_miso),
	.Data_Addr(AddrFromPi),
	.Data_Write(DataToPI),
	.Data_Read(DataFromPI),
	.Clk(CLOCK_50)
);


// ---  odometer module instantiation  ---------------------------------------

logic odoLA, odoLB, odoRA, odoRB;

odometer odoL (
	.reset(reset),
	.A(odoLA),
	.B(odoLB),
	.distance(Odometre_Left)
);
odometer odoR (
	.reset(reset),
	.A(odoRA),
	.B(odoRB),
	.distance(Odometre_Right)
);


// ---  Servo  instantation    -----------------------------------------------
	logic [31:0] Servo_control_LC, Servo_control_LP, Servo_control_RC, Servo_control_RP; 
	logic servo_LC, servo_LP, servo_RC, servo_RP;

	Servo_PWM SERVO_LC (
		.mclk(clk), 
		.control(Servo_control_LC), 
		.servo(servo_LC) 
	); 
	Servo_PWM SERVO_LP (
		.mclk(clk), 
		.control(Servo_control_LP), 
		.servo(servo_LP)
	); 
	Servo_PWM SERVO_RC (
		.mclk(clk), 
		.control(Servo_control_RC), 
		.servo(servo_RC)
	); 
	Servo_PWM SERVO_RP (
		.mclk(clk), 
		.control(Servo_control_RP), 
		.servo(servo_RP)
	); 


// ---  IR   instantation      -----------------------------------------------
// ---  Micro-swith instantation ---------------------------------------------
// ---  Dynamixels instantation ----------------------------------------------
// ---  Stepper instantation   -----------------------------------------------


//////////// Pin assignment for DE0_ANNICK //////////

//---SPI---//
assign spi_clk  		= GPIO_0[11];			//  11 (EDS Setup)
assign spi_cs   		= GPIO_0[9];			//  9  (EDS Setuo)
assign spi_mosi     	= GPIO_0[15];			//  15 (EDS Setup)
assign GPIO_0[13] = spi_cs ? 1'bz : spi_miso ;  //  13 (EDS Setup)

//---Odomètre---//
assign odoLA     = GPIO_0[8];
assign odoLB     = GPIO_0[9];
assign odoRA     = GPIO_0[10];
assign odoRB     = GPIO_0[11];

endmodule
